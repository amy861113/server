# 排程

## 簡介

有很多事情例行性(例如:起床、刷牙等等)的或臨時發生(剛好總公司有高官來訪，需要你準備演講器材)的。
由上述所說明，為了避免忘記這些事通常我們都會把它記錄在行事曆上!不過，由於我們常常在電腦前面的緣故，如果電腦系統能夠主動的通知我們的話，那麼不就輕鬆多了！嘿嘿！這個時候 Linux 的例行性工作排程就可以派上場了！在這時候我們就可以利用電腦排程工作。


## 章節

分成兩種工作排程:

- 一種是例行性的，就是每隔一定的週期要來辦的事項
- 一種是突發性的，就是這次做完以後就沒有的那一種 ( 3C 大降價...)

1. at:是個可以處理僅執行一次就結束排程的指令，而這個服務必須要有atd才行，然而在Ubuntu 18.04卻沒有這個服務，所以在Ubuntu 18.04下，我們必須用以下指令來下載at。
```shell=
$sudo apt install at
```

2. crontab:會依照指令設定一直循環下去，可循環的時間分成分鐘、小時、每周、每月或每年等。除了用指令執行，我們可以編輯/etc/crontab來支援，而crontab這個服務是由crond來支援。


## at

### 運行方式

用at指令來產生所要運行的工作，並寫入/var/spool/at/的目錄內，該工作就能等待atd取用並執行了。然而並不是所有人(帳號)都有這項at工作的權限，因為有很多hacker的程式，會"綁架"主機，他們可能利用這些程式，來定時傳送我們的資料給他們，所以下一章會講到如何權限限制。

### 權限限制

我們會利用/etc/at.allow和/etc/at.deny來管理權限。
1. /etc/at.allow；寫在這個檔案裡的帳號可以使用at。反之，不可以使用(即使沒有寫在at.deny)。
2. /etc/at.deny:當我們找不到etc/at.allow時，我們就會搜尋這個檔案，若寫在/etc/at.deny的使用者不能使用at。反之，沒有被寫入的使用者可使用at。
3. 兩個檔案都不存在:那麼就只有擁有root權限的帳號可以使用at。

由上可知。權限由嚴謹到鬆散可分為以下:

==都沒有 > /etc/at.allow > /etc/at.deny==

### 指令

1. 新增工作
```shell=
$at [-mldv] TIME
```
![](https://i.imgur.com/zTlZM4R.png)

### 範例
![](https://i.imgur.com/WP5MeVq.png)

![](https://i.imgur.com/NnvJFtN.png)

:::warning
下達這些指令建議最好用絕對路徑比較好，也比較不會出問題唷!
因為這些指令會牽扯到你的環境變數和目前你所在的檔案位置。
:::

:::success
at還有背景執行的功能，意思就是當如果電腦網路斷線離線時，也可以使用。
因為at的工作排程，系統會將該項工作獨立出bash的環境，直接交給系統的atd程式來管理，因此當你下達完指令後，就可以立刻離線。
:::

2. 查詢工作
```shell=
$atq
```

3. 移除工作
```shell=
$atrm (jobnumber) 
```
![](https://i.imgur.com/Vj43Tru.png)


附註:
```shell=
$systemctl restart atd #重新啟動服務
```
```shell=
$systemctl enable atd #讓這個服務開機就自動啟動
```
```shell=
$systemctl status atd #查閱atd目前的狀態
```

:::info
batch:系統有空時才執行的工作，每當cpu工作負載小於0.8時，工作才會執行。
:::
![](https://i.imgur.com/7oCWP1A.png)


## crontab

### 權限限制

跟at的模式很像，是由cron.allow和cron.deny來限制的。
但和at不太一樣的地方是它建立crontab指令的排程是寫入/var/spool/cron/帳號，也就是說它可以以帳號來區別，相對於at更方便來查詢了呢!

:::danger
但最好不要直接用nano、vi或vim等等的直接改寫裡面的指令。否則可能會因為語法錯誤，而導致無法執行cron喔!
:::

### 指令
```shell=
$crontab [-u username] [-l | -e | -r]
```

![](https://i.imgur.com/n7EpfKn.png)


| 代表意義 | 分鐘 | 小時 |日期 |月份 |週 |
|:-------:|:--:|:--:|:--:|:--:|:--:|
| 數字範圍| 0-59| 0-23| 1-31 |1-12|0-7|

:::danger
週與日月不可同時並存，不然很容易出現時間上的錯亂。
:::


| 特殊字符 | 代表意義 | 
| -------- | :-------- | 
| *(星號) |代表任何時刻都接受的意思！舉例來說，範例一內那個日、月、週都是 * ， 就代表著『不論何月、何日的禮拜幾的 12:00 都執行後續指令』的意思！  | 
|,(逗號)|	代表分隔時段的意思。舉例來說，如果要下達的工作是 3:00 與 6:00 時，就會是：0 3,6 * * * command，時間參數還是有五欄，不過第二欄是 3,6 ，代表 3 與 6 都適用！|
|-(減號)|代表一段時間範圍內，舉例來說， 8 點到 12 點之間的每小時的 20 分都進行一項工作：20 8-12 * * * command，仔細看到第二欄變成 8-12 喔！代表 8,9,10,11,12 都適用的意思！|
|/n(斜線)|那個 n 代表數字，亦即是『每隔 n 單位間隔』的意思，例如每五分鐘進行一次，則：*/5 * * * * command，很簡單吧！用 * 與 /5 來搭配，也可以寫成 0-59/5 ，相同意思！|

:::warning
指令下達時，最好使用絕對路徑，這樣比較不會找不到執行檔喔！
:::

### 系統的設定檔

```shell=
$crontab -e
```
以上這個指令是針對使用者的cron來設定，但如果要執行系統的例行性任務怎麼辦?這時只要直接編輯/etc/crontab就可以了。

:::info
cron 這個服務的最低偵測限制是『分鐘』，所以『 cron 會每分鐘去讀取一次 /etc/crontab 與 /var/spool/cron 裡面的資料內容 』，所以當編輯完/etc/crontab後並儲存，它的設定就會自動執行了。
:::

![](https://i.imgur.com/bP7GCG6.png)

- MAILTO=root:這個部分是用在當/etc/crontab這個檔案的例行性工作的指令發生錯誤時，會將錯誤訊息發送到此信箱，預設當然是系統發送給root(必須要有pop3)，我們可以將它改成自己常用的信箱。
- PATH=....：輸入執行檔的搜尋路徑！使用預設的路徑設定就已經很足夠了！
- 『分 時 日 月 周 身份 指令』七個欄位的設定:跟crontab -e 有些不一樣，會加上身分是因為我們當初是以使用者的身分的去下達任務，/etc/crontab 裡面當然要指定身份啦！此欄預設為root。

來源:
- http://linux.vbird.org/linux_basic/0430cron.php